{"version":2,"type":"job","id":"1c92ef50-cb18-4acd-8783-e0347c3d1844","name":"WorkflowAll.cpf","label":"WorkflowAll","description":"","created":1586028541975,"modified":1586043430521,"notes":"","parameters":{"server":"","target":"com.sas.ep.sascoder.execution.producers.VPP","action":"processFlow","priority":"Reserved"},"properties":{"left":"20","top":"20","width":"100","height":"60","region":"output","fillcolor":"#FCFCFC","linecolor":"#9a9a9a","tooltip":"","portsonly":false,"key":"control","visible":true,"readonly":false},"steps":[{"version":2,"type":"code","id":"12a66eed-12fe-4369-8ea5-69efc5ec47f5","name":"","label":"GenerateSetup","description":"","created":1586028541976,"modified":1586043424841,"notes":"","parameters":{"server":"","target":"com.sas.ep.sascoder.execution.producers.VPP","action":"runSASCode","priority":"Reserved","code":"/* clean up from previous runs if necessary */\nproc datasets library=WORK kill; run; quit;\n%global adjust_note\tadjust_date adjust_confirmed adjust_deaths;\n\n%let covidpath=/covid19data/csse_covid_19_data/csse_covid_19_daily_reports;\n%let progpath=/covid_analysis;\n%let outputpath=/covid_analysis/graphs/;\n\nlibname covid '/covid19data';   \nlibname fips \"&progpath./data\";        \nfilename covid19 \"&covidpath\";\n","snippet":"","resource":false},"properties":{"left":"50","top":"31","width":"100","height":"60","region":"output","fillcolor":"#E0E6F1","linecolor":"#6882a3","tooltip":"GenerateSetup","portsonly":true,"key":"control","visible":true}},{"version":2,"type":"code","id":"c5754165-c156-4f6a-80c0-542ce5cb0c1e","name":"","label":"MACROS","description":"","created":1586028541977,"modified":1586043361091,"notes":"","parameters":{"server":"","target":"com.sas.ep.sascoder.execution.producers.VPP","action":"runSASCode","priority":"Reserved","code":"\nproc format;\n\tpicture fipsfive low-high= \"99999\";\nrun;\n\n%macro AddAdjustment(typer,date,conf,death);\n\t%if &typer=1 %then %do;\n\t\t%put Running: AddAdjustment(&typer,&date,&conf,&death);\n\t\tif filedate = \"&date\" then do;\n\t\t\tconfirmed = &conf;\n\t\t\tdeaths \t  = &death;\n\t\tend;\n\t\t%LET adjust_note=Adjusted for &date: Confirmed = &conf Deaths = &death;\n\t%end;\n\t%put note = &adjust_note;\n%mend AddAdjustment;\n\n%macro AddData(typer,loca,date,conf,death);\n\t%if &typer=1 %then %do;\n\t\tproc sql;\n\t\t\tinsert into JHU_CORE_TS\n\t\t\t\t(location,filedate, confirmed, deaths) \n\t\t\t\tvalues (\"&loca\",\"&date\",&conf,&death);\n\t\tquit;\n\t\t%recalculate_JHU_Summary;\n\t%end;\n%mend AddData;\n\n/* Define a macro for offset */\n%macro offset ();\n\t%if %sysevalf(&respmin eq 0) %then\n\t\t%do;\n\t\t\toffsetmin=0 %end;\n\n\t%if %sysevalf(&respmax eq 0) %then\n\t\t%do;\n\t\t\toffsetmax=0 %end;\n%mend offset;\n\n\n%macro SetNote;\n\t%put NOTE: Adjust_note = &adjust_note;\n\t%if %length(&adjust_note)>0 %then  %do;\n\t\ttitle3 \"&adjust_note\";\n\t%end;\n\t%else %do;\n\t\ttitle3;\n\t%end;\n%mend SetNote;\n\n\n%macro LoadCSV(infilepath,outdataset,typer,counter);\n\n\tdata JHU&outdataset    ;\n\t\t   infile \"&infilepath\" \n\t\t   delimiter = ',' \n\t\t   MISSOVER \n\t\t   DSD\n\t\t   lrecl=32767 \n\t\t   firstobs=2 ;\n\t\tformat FIPS $5. ;\n\t\tformat Admin2 $50. ;\n\t\tformat Province_State $50. ;\n\t\tformat Country_Region $50. ;\n\t\tformat Last_Update datetime. ;\n\t\tformat Lat best12. ;\n\t\tformat Long_ best12. ;\n\t\tformat Confirmed comma. ;\n\t\tformat Deaths comma. ;\n\t\tformat Recovered comma. ;\n\t\tformat Active comma. ;\n\t\tformat Combined_Key $50. ;\n\t\tinformat FIPStemp best32. ;\n\t\tinformat Admin2 $50. ;\n\t\tinformat Province_State $50. ;\n\t\tinformat Country_Region $50. ;\n\t\tinformat Last_Update anydtdtm40. ;\n\t\tinformat Lat best32. ;\n\t\tinformat Long_ best32. ;\n\t\tinformat Confirmed best32. ;\n\t\tinformat Deaths best32. ;\n\t\tinformat Recovered best32. ;\n\t\tinformat Active best32. ;\n\t\tinformat Combined_Key $50. ;\n\n\t\t%if &typer=1 %then %do;\n\t\t\tinput\n\t\t\t   FIPStemp $\n\t\t\t   Admin2  $\n\t\t\t   Province_State  $\n\t\t\t   Country_Region  $\n\t\t\t   Last_Update\n\t\t\t   Lat\n\t\t\t   Long_\n\t\t\t   Confirmed\n\t\t\t   Deaths\n\t\t\t   Recovered\n\t\t       Active                    \n\t\t       Combined_Key  $\n\t\t \t;\n\t\t%end;\n\t\t%else %if &typer=2 %then %do;\n\t\t \tinput\n\t\t\t\tProvince_State  $\n\t\t\t\tCountry_Region  $\n\t\t\t\tLast_Update\n\t\t\t\tConfirmed\n\t\t\t\tDeaths\n\t\t\t\tRecovered\n\t\t\t;\n\t\t%end;\n\t \tst_filedate=\"&outdataset\";\n\t \tfiledate=mdy(substr(st_filedate,5,2),substr(st_filedate,7,2),substr(st_filedate,1,4));\n\t\tformat filedate yymmdd10.;\n\t \tlabel filedate=\"File Date\";\n\t \tfips = put(fipstemp,fipsfive.);\n\t \tdrop fipstemp;\n\t \tif province_state = \"\" then Location=cats(\"Nation:\",country_region);\n\t\telse location = cats(province_state,\" - \",country_region);\n\t\tplotlabel_date = cats(location,\":\",substr(filedate,5,2),\"/\",substr(filedate,7,2));\n\n\trun;  \n\t%if &typer=2 %then %do;\n\t\t%if &counter=1 %then %do;\n\t\t\tdata JHU_Legacy;\n\t\t\t\tset JHU&outdataset;\n\t\t\trun;\n\t\t%end;\n\t\t%else %do;\n\t\t\tdata JHU_Legacy;\n\t\t\t\tset JHU_Legacy JHU&outdataset;\n\t\t\trun;\n\t\t%end;\n\t%end;\n\t%else %if &typer=1 %then %do;\n\t\t%if &counter=1 %then %do;\n\t\t\tdata JHU_current;\n\t\t\t\tset JHU&outdataset;\n\t\t\trun;\n\t\t%end;\n\t\t%else %do;\n\t\t\tdata JHU_current;\n\t\t\t\tset JHU_current JHU&outdataset;\n\t\t\t\t\n\t\t\trun;\n\t\t%end;\n\t%end;\n\t\n%mend LoadCSV;\n\n%macro create_jhu_summary;\n\n\t/* this macro makes it possible to recalcuate the summaries after new data is added manually */\n\t/* Create the full dataset */\n\tproc sql;\n\t\tcreate table JHU_current_TS as\n\t\t\tselect\n\t\t\t\t fips\n\t\t\t\t,location\n\t\t\t\t,province_state\n\t\t\t\t,country_region\n\t\t\t\t,filedate\n\t\t\t\t,sum(confirmed) as confirmed\n\t\t\t\t,sum(deaths) as deaths\n\t\t\t\t,sum(recovered) as recovered\n\t\t\tfrom jhu_current\n\t\t\t\tgroup by fips,location,province_state,country_region,filedate\n\t\t;\n\t\tcreate table JHU_LEGACY_TS as\n\t\t\tselect\n\t\t\t\t fips\n\t\t\t\t,location\n\t\t\t\t,filedate\n\t\t\t\t,province_state\n\t\t\t\t,country_region\n\t\t\t\t,sum(confirmed) as confirmed\n\t\t\t\t,sum(deaths) as deaths\n\t\t\t\t,sum(recovered) as recovered\n\t\t\tfrom jhu_legacy\n\t\t\t\tgroup by fips,location,province_state,country_region,filedate\n\t\t;\n\tquit;\n\tdata JHU_CORE_TS;\n\t\tset JHU_LEGACY_TS JHU_CURRENT_TS;\n\trun;\n\t/* This summarizes the previous table to location, over dates */\n\tproc sql;\n\tcreate table JHU_CORE_TS_CENSUS_SUMMARY as\n\t\tselect \n\t\t     fips\n\t\t    ,location\n\t\t\t,stname as census_state\n\t\t\t,ctyname as census_county\n\t\t\t,filedate\n\t\t\t,count(*) as freq\n\t\t\t,sum(confirmed) as confirmed format=comma16. label=\"Confirmed Cases\"\n\t\t\t,sum(deaths) as deaths format=comma16. label=\"Deaths\"\n\t\t\t,max(census2010pop) as population_estimate format=comma16. label=\"2010 Census Population Estimate\"\n\t\t\t,sum(deaths)/sum(confirmed) as emp_fatality_rate format=percent7.5 label=\"Fatality Rate\"\n\t\t\t,sum(confirmed)/max(census2010pop) as confirmed_percapita format=percent7.5 label=\"Infections Per Capita\"\n\t\t\t,sum(deaths)/max(census2010pop) as deaths_percapita format=percent7.5 label=\"Deaths Per Capita\"\n\t\tfrom JHU_CORE_TS as jhu\n\t\t\tleft join \n\t\t\t FIPS.POPULATION_ESTIMATES as census\n\t\t\ton jhu.fips = census.fips_join\n\t\twhere fips is not null \n\t\tgroup by\n\t\t\t fips\n\t\t\t ,location\n\t\t\t,stname\n\t\t\t,ctyname\n\t\t\t,filedate\n\t\torder by fips,location,filedate\n\t\t\t,stname\n\t\t\t,ctyname;\n\n\t\tcreate table JHU_CORE_LOC_CENSUS_ICU_SUMMARY as\t\n\t\t\tselect \n\t\t\t    jhu.fips label=\"FIPS\"\n\t\t\t    ,jhu.province_state\n\t\t\t    ,jhu.country_region\n\t\t\t\t,location label=\"Location\"\n\t\t\t\t,pop.state label=\"State\"\n\t\t\t\t,pop.county\tlabel=\"County\"\t\t\n\t\t\t\t,filedate label=\"File Date\"\n\t\t\t\t,confirmed label=\"Confirmed\"\n\t\t\t\t,deaths label=\"Deaths\"\n\t\t\t\t,recovered label=\"Recovered\"\n\t\t\t\t,pop.census2010pop as population_estimate label=\"County Population\"\n\t\t\t\t,sum(deaths)/sum(confirmed) as emp_fatality_rate format=percent7.5 label=\"Fatality Rate\"\n\t\t\t\t,sum(confirmed)/max(pop.census2010pop) as confirmed_percapita format=percent7.5 label=\"Infections Per Capita\"\n\t\t\t\t,sum(deaths)/max(pop.census2010pop) as deaths_percapita format=percent7.5 label=\"Deaths Per Capita\"\n\n\t\t\t\t,case when hospitals=. then 0 else hospitals end as county_hospitals label=\"County Hospitals\"\n\t\t\t\t,case when icu_beds =. then 0 else icu_beds  end as county_icu_beds  label=\"County ICU Beds\"\n\t\t\t\tfrom(\n\t\t\t\t\tselect \n\t\t\t\t\t\tjhu.fips\n\t\t\t\t\t\t,location\n\t\t\t\t\t\t,county\n\t\t\t\t\t\t,state\n\t\t\t\t\t\t,filedate\n\t\t\t\t\t\t,confirmed\n\t\t\t\t\t\t,deaths\n\t\t\t\t\t\t,recovered\n\t\t\t\t\t\t,pop.census2010pop \n\t\t\t\t\tfrom JHU_CORE_TS as jhu\n\t\t\t\t\tleft join fips.population_estimates pop\n\t\t\t\t\ton jhu.fips=pop.fips_join\n\t\t\t\t)\n\t\t\tleft join fips.ICU_BEDS icu\n\t\t\ton jhu.fips = icu.fips;\n\t\n\n\tquit;\n%mend;\n%macro recalculate_JHU_Summary;\n\tproc sql;\n\t\tcreate table JHU_CORE_TS_ICU_census as\n\t\t\tselect \n\t\t\t\tfips\n\t\t\t\t,location\n\t\t\t\t,filedate\n\t\t\t\t,sum(confirmed) as confirmed\n\t\t\t\t,sum(deaths) as deaths\n\t\t\t\t,sum(recovered) as recovered\n\t\t\t\t,max(population_estimate) as population_estimate label=\"2010 County Poputlation Estimate\"\n\t\t\t\t,max(county_hospitals) as total_county_hospitals label=\"Total County Hospitals\"\n\t\t\t\t,max(county_icu_beds) as total_county_icu_beds label=\"Total ICU Beds\"\n\t\t\t\t,max(emp_fatality_rate) as emp_fatality_rate format=percent7.5 label=\"Fatality Rate\"\n\t\t\t\t,max(confirmed_percapita) as confirmed_percapita format=percent7.5 label=\"Infections Per Capita\"\n\t\t\t\t,max(deaths_percapita) as deaths_percapita  format=percent7.5 label=\"Deaths Per Capita\"\n\t\t\tfrom JHU_CORE_LOC_CENSUS_ICU_SUMMARY\n\t\t\t\tgroup by \n\t\t\t\t\tfips\n\t\t\t\t\t,location\n\t\t\t\t\t,filedate\n\t\t\t\torder by  \n\t\t\t\t\tfips\n\t\t\t\t\t,location\n\t\t\t\t\t,filedate\n\t\t\t;\n\t\tcreate table JHU_CORE_LOC_ICU_Census as\n\t\t\tselect\n\t\t\t\t fips\n\t\t\t\t,location\n\t\t\t\t,county\n\t\t\t\t,sum(confirmed) as confirmed\n\t\t\t\t,sum(deaths) as deaths\n\t\t\t\t,sum(recovered) as recovered\n\t\t\t\t,max(population_estimate) as population_estimate label=\"2010 County Poputlation Estimate\"\n\t\t\t\t,max(county_hospitals) as total_county_hospitals label=\"Total County Hospitals\"\n\t\t\t\t,max(county_icu_beds) as total_county_icu_beds label=\"Total ICU Beds\"\n\t\t\t\t,max(emp_fatality_rate) as emp_fatality_rate format=percent7.5 label=\"Fatality Rate\"\n\t\t\t\t,max(confirmed_percapita) as confirmed_percapita format=percent7.5 label=\"Infections Per Capita\"\n\t\t\t\t,max(deaths_percapita) as deaths_percapita  format=percent7.5 label=\"Deaths Per Capita\"\n\n\t\t\tfrom JHU_CORE_LOC_CENSUS_ICU_SUMMARY\n\t\t\t\tgroup by\n\t\t\t\t\tfips\n\t\t\t\t\t,county\n\t\t\t\t\t,location\n\t\t\t\torder by \n\t\t\t\t\t fips\n\t\t\t\t\t ,county\n\t\t\t\t\t ,location\n\t\t\t;\n\n\t\tcreate table JHU_CORE_LOC_MSA_ICU as\t\n\t\tselect \n\t\t\tjhu.*\n\t\t\t,case when cbsa.CSA_TITLE='' \n\t\t\t\tthen cats(\n\t\t\t\t\tcase when jhu.county='' \n\t\t\t\t\t\tthen \"Unassigned\" \n\t\t\t\t\t\telse jhu.county\n\t\t\t\t\t\tend\n\t\t\t\t\t,\",\",location) \n\t\t\t\telse cbsa.CSA_TITLE \n\t\t\t\tend as CSA_Title_Augmented\n\t\tfrom  JHU_CORE_LOC_ICU_CENSUS JHU\n\t\tleft join work.CBSA_County_crosswalk cbsa\n\t\t\ton jhu.fips = cbsa.fipsjoin\n\t\t\twhere scan(location,2,'-') = 'US'\n\t\t;\n\tquit;\n%mend;\n\n\n%macro setmax(dataclause,whereclause,additionalvars=);\n\tproc means data=&dataclause(where=(&whereclause)) noprint;\n\t\tvar confirmed deaths;\n\t\toutput out=tmeans max(confirmed deaths) =confirmed deaths;\n\trun;\n\tdata _null_; \n\t\tset tmeans;\n\t\tcall symput(\"maxconfirmed\",confirmed);\n\t\tcall symput(\"maxdeaths\",deaths);\n\trun;\n\t%put [&maxconfirmed, &maxdeaths];\n\tproc sql; drop table tmeans; quit;\n%mend setmax;\n\n\n%macro PlotInd(prex,loca,sufx,ta=0,dt=0,ac=0,ad=0,jt=0,jf=0,jc=0,jd=0);\n\t/* this sloppy way to call a funciton is not optimal - i will fix later */\n\t%let prefix=&prex;\n\t%let pvs=&loca;\n\t%let suffix=&sufx;\n\t\n\t/*\n\tproc sql; \n\tselect * from jhu_icu_timeseries where upcase(location) like \"%GERM%\";\n\tquit;\n\t*/\n\t/**********************************/\n\t/********** ADJUSTMENTS ************/\n\t/**********************************/\n\t\t%let adjust_type=&jt; /*set to 0 for no adjustment */\n\t\t%let adjust_date=&jf;\n\t\t%let adjust_confirmed=&jc;*3032;\n\t\t%let adjust_deaths=&jd;*102;\n\t\t%let adjust_note=;\n\t\t/* THIS WILL RESULT IN DUPLICATE FOR MULTIPLE RUNS WITH add_typer=1!!! */\n\t\t/* Run once with 1, then set to 0 */\n\t\t%let add_typer=&ta;\n\t\t%let add_date=&dt;\n\t\t%let add_confirmed=&ac;\n\t\t%let add_deaths=&ad;\n\t\t\n\t%include \"&progpath./GraphSingular.sas\";\n\t\t\n%mend PlotInd;\n\n%macro cleanupds;\n\tproc contents data=work._all_ out =workds ;run;\n\tproc sql noprint; select distinct memname into :delds separated by ' ' from workds where substr(memname,1,5)='JHU20'; quit;\n\t\n\t%put NOTE: Deleteing &delds; \n\tproc delete data=&delds workds; run;\n%mend;\n\n","snippet":"","resource":false,"dependencies":["12a66eed-12fe-4369-8ea5-69efc5ec47f5"]},"properties":{"left":"240","top":"30","width":"100","height":"60","region":"output","fillcolor":"#E0E6F1","linecolor":"#6882a3","tooltip":"MACROS","portsonly":true,"key":"control","visible":true}},{"version":2,"type":"job","id":"40a807ad-5b30-45f8-80f7-f2e5c68560be","name":"","label":"Load Data from Source","description":"","created":1586041384796,"modified":1586085711042,"notes":"","parameters":{"server":"","target":"com.sas.ep.sascoder.execution.producers.VPP","action":"processFlow","priority":"Reserved","dependencies":["c5754165-c156-4f6a-80c0-542ce5cb0c1e"]},"properties":{"left":"430","top":"30","width":"100","height":"60","region":"output","fillcolor":"#FCFCFC","linecolor":"#9a9a9a","tooltip":"Load Data from Source","portsonly":true,"key":"control","visible":true,"readonly":false},"steps":[{"version":2,"type":"code","id":"660e2cb6-c1b0-47d1-88e4-1b4627a62b95","name":"","label":"HardLoadData","description":"","created":1586041384811,"modified":1586043324875,"notes":"","parameters":{"server":"","target":"com.sas.ep.sascoder.execution.producers.VPP","action":"runSASCode","priority":"Reserved","code":"*****************************************************************\n***** HardLoadData.sas\n***** pulls and prepares csv data from covid19 using proc import\n***** generated data steps. You have to run sanity checks on this\n*****************************************************************;\n;\n\n%let rc = %sysfunc(dlgcdir(\"&covidpath\"));\noptions nomlogic nomprint;\ndata _null_;\n\tlegacy_count=0;\n\tcurrent_count=0;\n\thandle=dopen('covid19');\n\tif handle > 0 then do;\n\t\tcount=dnum(handle);\n\t\tdo i=1 to count;\n\t\t\tmemname=dread(handle,i);\n\t\t\tfilepref = scan(memname,1,'.');\n\t\t\tfileext  = scan(memname,2,\".\");\n\t\t\tif fileext = \"csv\" then do;\n\t\t\t\tfiledate = compress(cats(scan(filepref,3,'-'),scan(filepref,1,'-'),scan(filepref,2,'-')));\n\t\t\t\tif filedate <= '20200321' then do; /* this accounts for JHU infile structure change */\n\t\t\t\t\tlegacy_count+1;\n\t\t\t\t\tcall execute(cats('%LoadCSV(&covidpath/',memname,',',filedate,',',2,',',legacy_count,')'));\n\t\t\t\tend;\n\t\t\t\telse do;\n\t\t\t\t\tcurrent_count+1;\n\t\t\t\t\tcall execute(cats('%LoadCSV(&covidpath/',memname,',',filedate,',',1,',',current_count,')'));\n\t\t\t\tend;\n\t\t\tend;\n\t\tend;\n\tend;\n\trc=dclose(handle);\nrun;\n\n%let rc = %sysfunc(dlgcdir(\"&outputpath\"));\n\n","snippet":"","resource":false},"properties":{"left":"50","top":"85","width":"100","height":"60","region":"output","fillcolor":"#E0E6F1","linecolor":"#6882a3","tooltip":"HardLoadData","portsonly":true,"key":"control","visible":true}},{"version":2,"type":"code","id":"c86ca3fe-a150-4d37-836e-d44d6cb91f16","name":"","label":"ImportMSACBSA","description":"","created":1586041384812,"modified":1586043324868,"notes":"","parameters":{"server":"","target":"com.sas.ep.sascoder.execution.producers.VPP","action":"runSASCode","priority":"Reserved","code":"/* County to CBSA Crosswalk: Source: https://www.census.gov/programs-surveys/metro-micro/about/delineation-files.html */\n/* https://www2.census.gov/programs-surveys/metro-micro/geographies/reference-files/2018/delineation-files/list1_Sep_2018.xls */\ndata WORK.CBSA_County_Crosswalk   ;\n\t\n\tinfile \"&progpath./data/MSA_CountyFipsCrosswalk.csv\" \n\t\tdelimiter = ',' \n\t\tMISSOVER \n\t\tDSD  \n\t\tfirstobs=2 ;\n\tinformat CBSA_Code $234. ;\n\tinformat Metropolitan_Division_Code best32. ;\n\tinformat CSA_Code best32. ;\n\tinformat CBSA_Title $48. ;\n\tinformat MSA $29. ;\n\tinformat MSA_Title $51. ;\n\tinformat CSA_Title $62. ;\n\tinformat County_Equivalent $28. ;\n\tinformat State_Name $20. ;\n\tinformat FIPS_State_Code $2. ;\n\tinformat FIPS_County_Code $3. ;\n\tinformat Central_Outlying_County $8. ;\n\tformat CBSA_Code $234. ;\n\tformat Metropolitan_Division_Code best12. ;\n\tformat CSA_Code best12. ;\n\tformat CBSA_Title $48. ;\n\tformat MSA $29. ;\n\tformat MSA_Title $51. ;\n\tformat CSA_Title $62. ;\n\tformat County_Equivalent $28. ;\n\tformat State $20. ;\n\tformat FIPS_State_Code $2. ;\n\tformat FIPS_County_Code $3. ;\n\tformat Central_Outlying_County $8. ;\n\tinput\n\t\tCBSA_Code $\n\t\tMetropolitan_Division_Code \n\t\tCSA_Code \n\t\tCBSA_Title $\n\t\tMSA $\n\t\tMSA_Title $\n\t\tCSA_Title $\n\t\tCounty_Equivalent $\n\t\tState $\n\t\tFIPS_State_Code $\n\t\tFIPS_County_Code $\n\t\tCentral_Outlying_County $\n\t;\n\tFIPSjoin=cats(fips_state_code,fips_county_code);\n\tif missing(fipsjoin) then delete;\nrun;\n\n/* proc sql; */\n/* select * from cbsa_county where fipsjoin =''; */\n/* select fipsjoin, count(*) as freq from WORK.CBSA_County group by fipsjoin order by fipsjoin; */\n/* select * from cbsa_county where fips_state_code='45'; */\n/* quit; */\n\n\n\n\n\n\n\n\n","snippet":"","resource":false,"dependencies":["660e2cb6-c1b0-47d1-88e4-1b4627a62b95"]},"properties":{"left":"240","top":"30","width":"100","height":"60","region":"output","fillcolor":"#E0E6F1","linecolor":"#6882a3","tooltip":"ImportMSACBSA","portsonly":true,"key":"control","visible":true}},{"version":2,"type":"code","id":"073a7a07-9dc6-469d-8ab4-8b001c99def2","name":"","label":"LoadICUBeds","description":"","created":1586041384812,"modified":1586043324877,"notes":"","parameters":{"server":"","target":"com.sas.ep.sascoder.execution.producers.VPP","action":"runSASCode","priority":"Reserved","code":"/* CROKER - This data set may be incorrect. \n\tNeed to find the original from Kaiser Family Foundation - ICU beds */\nproc format;\n\tpicture fipsfive low-high= \"99999\";\nrun;\n\nfilename kff_ICU url 'https://s3-us-west-1.amazonaws.com/starschema.covid/KFF_US_ICU_BEDS.csv';\ndata fips.ICU_BEDS    ;\n\tinfile kff_icu delimiter = ',' MISSOVER DSD  firstobs=2 ;\n\t   format COUNTRY_REGION $13. ;\n\t   format FIPS $5. ;\n\t   format COUNTY $25. ;\n\t   format STATE $20. ;\n\t   format ISO3166_1 $2. ;\n\t   format ISO3166_2 $2. ;\n\t   format HOSPITALS best12. ;\n\t   format ICU_BEDS best12. ;\n\t   format NOTE $100. ;\n\t   informat COUNTRY_REGION $100. ;\n\t   informat COUNTY $100. ;\n\t   informat STATE $100. ;\n\t   informat ISO3166_1 $2. ;\n\t   informat ISO3166_2 $2. ;\n\t   informat HOSPITALS best32. ;\n\t   informat ICU_BEDS best32. ;\n\t   informat NOTE $100. ;\n\t   informat fipstemp best32.;\n\tinput\n\t            COUNTRY_REGION  $\n\t            FIPStemp $\n\t            COUNTY  $\n\t            STATE  $\n\t            ISO3166_1  $\n\t            ISO3166_2  $\n\t            HOSPITALS\n\t            ICU_BEDS\n\t            NOTE  $\n\t;\n\tfips = scan(put(fipstemp,fipsfive.),1,'.');\n\t\n\tdrop fipstemp;\nrun;\n \n \n \n \n \n \n \n \n \n ","snippet":"","resource":false,"dependencies":["660e2cb6-c1b0-47d1-88e4-1b4627a62b95"]},"properties":{"left":"240","top":"140","width":"100","height":"60","region":"output","fillcolor":"#E0E6F1","linecolor":"#6882a3","tooltip":"LoadICUBeds","portsonly":true,"key":"control","visible":true}},{"version":2,"type":"code","id":"ac1a240c-ad82-4aa8-8ab3-766cf71a7e69","name":"","label":"GenerateSummaryTables","description":"","created":1586041384812,"modified":1586043324871,"notes":"","parameters":{"server":"","target":"com.sas.ep.sascoder.execution.producers.VPP","action":"runSASCode","priority":"Reserved","code":"%create_jhu_summary;\n%recalculate_JHU_Summary;\n%cleanupds;\n","snippet":"","resource":false,"dependencies":["073a7a07-9dc6-469d-8ab4-8b001c99def2","c86ca3fe-a150-4d37-836e-d44d6cb91f16"]},"properties":{"left":"430","top":"85","width":"100","height":"60","region":"output","fillcolor":"#E0E6F1","linecolor":"#6882a3","tooltip":"GenerateSummaryTables","portsonly":true,"key":"control","visible":true}}],"ports":[{"version":2,"type":"port","id":"870a215c-7c0f-4bd0-8369-e1445d119341","name":"","label":"","description":"","created":1586041384813,"modified":1586043324874,"notes":"","parameters":{},"properties":{"left":"30","top":"108","width":"13","height":"13","parent":"660e2cb6-c1b0-47d1-88e4-1b4627a62b95","region":"input","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"d7add526-f235-4b44-86d6-83d1ce08a5da","name":"","label":"","description":"","created":1586041384813,"modified":1586043324874,"notes":"","parameters":{},"properties":{"left":"157","top":"108","width":"13","height":"13","parent":"660e2cb6-c1b0-47d1-88e4-1b4627a62b95","region":"output","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"aedae46a-f5bb-4ca0-82d4-d39dcd1d684f","name":"","label":"","description":"","created":1586041384813,"modified":1586043324867,"notes":"","parameters":{},"properties":{"left":"220","top":"53","width":"13","height":"13","parent":"c86ca3fe-a150-4d37-836e-d44d6cb91f16","region":"input","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"ed171b0b-deff-4768-8bae-c7c3a9cd70e1","name":"","label":"","description":"","created":1586041384813,"modified":1586043324867,"notes":"","parameters":{},"properties":{"left":"347","top":"53","width":"13","height":"13","parent":"c86ca3fe-a150-4d37-836e-d44d6cb91f16","region":"output","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"2faf35a8-5aa0-4d2d-8be2-e739f0a031a1","name":"","label":"","description":"","created":1586041384813,"modified":1586043324877,"notes":"","parameters":{},"properties":{"left":"220","top":"163","width":"13","height":"13","parent":"073a7a07-9dc6-469d-8ab4-8b001c99def2","region":"input","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"f467c757-249a-49a5-8414-2415d1a5c249","name":"","label":"","description":"","created":1586041384813,"modified":1586043324877,"notes":"","parameters":{},"properties":{"left":"347","top":"163","width":"13","height":"13","parent":"073a7a07-9dc6-469d-8ab4-8b001c99def2","region":"output","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"a6eede74-a5ee-4235-83bd-16a282516d74","name":"","label":"","description":"","created":1586041384813,"modified":1586043324870,"notes":"","parameters":{},"properties":{"left":"410","top":"108","width":"13","height":"13","parent":"ac1a240c-ad82-4aa8-8ab3-766cf71a7e69","region":"input","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"5c3adc3d-d446-4ca7-8597-60e8449cebb3","name":"","label":"","description":"","created":1586041384813,"modified":1586043324871,"notes":"","parameters":{},"properties":{"left":"537","top":"108","width":"13","height":"13","parent":"ac1a240c-ad82-4aa8-8ab3-766cf71a7e69","region":"output","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}}],"connectors":[{"version":2,"type":"link","id":"68890b26-546b-4ae3-8280-5748484a67a8","name":"","label":"","description":"","created":1586041384814,"modified":1586041384814,"notes":"","parameters":{},"properties":{"linecolor":"#C0C0C0","linestyle":"Dash"},"sources":[{"value":"f467c757-249a-49a5-8414-2415d1a5c249"}],"targets":[{"value":"a6eede74-a5ee-4235-83bd-16a282516d74"}]},{"version":2,"type":"link","id":"f30b7a60-9e55-4139-8ab1-2c735db3facf","name":"","label":"","description":"","created":1586041384814,"modified":1586041384814,"notes":"","parameters":{},"properties":{"linecolor":"#C0C0C0","linestyle":"Dash"},"sources":[{"value":"d7add526-f235-4b44-86d6-83d1ce08a5da"}],"targets":[{"value":"aedae46a-f5bb-4ca0-82d4-d39dcd1d684f"}]},{"version":2,"type":"link","id":"1909f7d2-c692-4394-87ad-ad7affd76714","name":"","label":"","description":"","created":1586043284697,"modified":1586043284697,"notes":"","parameters":{},"properties":{"linecolor":"#C0C0C0","linestyle":"Dash"},"sources":[{"value":"d7add526-f235-4b44-86d6-83d1ce08a5da"}],"targets":[{"value":"2faf35a8-5aa0-4d2d-8be2-e739f0a031a1"}]},{"version":2,"type":"link","id":"2acfc1c3-5f06-467f-87a7-a952092b8910","name":"","label":"","description":"","created":1586043299504,"modified":1586043299504,"notes":"","parameters":{},"properties":{"linecolor":"#C0C0C0","linestyle":"Dash"},"sources":[{"value":"ed171b0b-deff-4768-8bae-c7c3a9cd70e1"}],"targets":[{"value":"a6eede74-a5ee-4235-83bd-16a282516d74"}]}]},{"version":2,"type":"job","id":"e3a49f07-37dc-445d-8600-3007ae53d83a","name":"","label":"Generate Graphs","description":"","created":1586041393424,"modified":1586085711045,"notes":"","parameters":{"server":"","target":"com.sas.ep.sascoder.execution.producers.VPP","action":"processFlow","priority":"Reserved","dependencies":["40a807ad-5b30-45f8-80f7-f2e5c68560be"]},"properties":{"left":"620","top":"30","width":"100","height":"60","region":"output","fillcolor":"#FCFCFC","linecolor":"#9a9a9a","tooltip":"Generate Graphs","portsonly":true,"key":"control","visible":true,"readonly":false},"steps":[{"version":2,"type":"code","id":"1103de1b-51ed-416d-806c-9f034469f2c9","name":"","label":"GraphTrajectories","description":"","created":1586041393432,"modified":1586041393432,"notes":"","parameters":{"server":"","target":"com.sas.ep.sascoder.execution.producers.VPP","action":"runSASCode","priority":"Reserved","code":"\n%let rc = %sysfunc(dlgcdir(\"/covid_analysis\"));\n\nproc sort data=JHU_CORE_TS out=allcompose;\n\tby location filedate;\nrun;\n\nproc means data=allcompose noprint;\n\t\n\tclass location filedate/ order=data;\n\tvar confirmed deaths;\n\toutput out=allcompose_summary \n\t\t(where=(_type_ = 3) )\n\t\tsum(confirmed deaths)=confirmed deaths;\n\tlabel confirmed=\"Confirmed Infections\"\n\t\t  deaths=\"Deaths\"\n\t\t  location='Location';\nrun;\n/* sanity check - check for type \nproc sql; \nselect _type_,count(*) as freq from allcompose_summary group by _type_ order by _type_;\nselect * from allcompose_summary where _type_ = 7 and location = 'Georgia-US';\nquit;\n*/\n\n\n\nproc sort data=allcompose_summary;by location filedate;run;\ndata plotstate;\n\tset allcompose_summary;\n\tkeep location confirmed deaths;\n\tby location filedate;\n\tif last.location and last.filedate then output; \nrun;\n\nproc sql noprint; \n\tselect distinct location into :smallstates separated by '\",\"' from plotstate where confirmed between 100 and 800 and deaths>5; \n\tselect distinct location into :middlestates separated by '\",\"' from plotstate where confirmed between 800 and 2500 and deaths>5; \n\tselect distinct location into :bigstates separated by '\",\"' from plotstate where confirmed >= 2500 and deaths>5 ; \n\tselect distinct location into :usstates separated by '\",\"' from plotstate where  location contains '-US' and confirmed > 1 and deaths > 1 ; \nquit;\n\n\n/* Make the output destination BIG so you can zoom in */\noptions orientation=landscape papersize=(24in 24in) ;\nods graphics on / reset width=24in height=24in  imagemap outputfmt=svg;\nods html close;ods rtf close;ods pdf close;ods document close; \nods html5 file=\"&outputpath./trajectories/ProvenceTrajectories.html\" gpath= \"&outputpath./trajectories\" device=svg options(svg_mode=\"inline\");\n\t\ttitle Province Trajectories;\n\ttitle2 Between 100 and 800 Total Cases;\n\tfootnote 'Data Source: Johns Hopkins University - https://github.com/CSSEGISandData/COVID-19';\n\tproc sgplot data=allcompose_summary(where=(confirmed>10 and deaths > 2)) noautolegend;\n\t\tscatter x=Confirmed y=Deaths / group=location \n\t\t\tdatalabel=filedate\n\t\t\tmarkerattrs=(size=7) \n\t\t\tdatalabelattrs=(size=5) \n\t\t\ttransparency=0.25\n\t\t\ttip=(location filedate confirmed deaths);\n\t\tseries x=Confirmed y=Deaths  / group=location \n\t\t\ttip=(location filedate confirmed deaths);\n\t\txaxis grid type=log min=0 LOGSTYLE=LINEAR ;\n\t\tyaxis grid type=log min=0 LOGSTYLE=LINEAR ;\n\t\twhere location in (\"&smallstates\");\n\trun;\n\t\n\t/**************************************************************/\n\ttitle Province Trajectories;\n\ttitle2 Between 800 and 2500 Total Cases;\n\tproc sgplot data=allcompose_summary(where=(confirmed>50 and deaths > 5))  noautolegend;\n\t\tscatter x=Confirmed y=Deaths / group=location\n\t\t\tdatalabel=filedate\n\t\t\tmarkerattrs=(size=7) \n\t\t\tdatalabelattrs=(size=5) \n\t\t\ttransparency=0.25\n\t\t\ttip=(location filedate confirmed deaths);\n\t\tseries x=Confirmed y=Deaths  / group=location \n\t\t\ttip=(location filedate confirmed deaths);\n\t\txaxis grid type=log min=0  LOGSTYLE=LINEAR ;\n\t\tyaxis grid type=log min=0  LOGSTYLE=LINEAR ;\n\t\twhere location in (\"&middlestates\");\n\trun;\n\t\n\t/**************************************************************/\n\ttitle Province Trajectories;\n\ttitle2 Greater Than 2500 Total Confirmed;\n\tproc sgplot data=allcompose_summary(where=(confirmed>100and deaths > 10))  noautolegend;\n\t\tscatter x=Confirmed y=Deaths / group=location\n\t\t\tdatalabel=filedate\n\t\t\tmarkerattrs=(size=7) \n\t\t\tdatalabelattrs=(size=5) \n\t\t\ttransparency=0.25\n\t\t\ttip=(location filedate confirmed deaths);\n\t\tseries x=Confirmed y=Deaths  / group=location \n\t\t\ttip=(location filedate confirmed deaths);\n\t\txaxis grid type=log min=0  LOGSTYLE=LINEAR;* values=(5 10 100 1000 10000 100000);\n\t\tyaxis grid type=log max=0  LOGSTYLE=LINEAR;* values=(5 10 100 500  1000 );\n\t\twhere location in (\"&bigstates\");\n\trun;\nods html5 close;\nods graphics / reset;\n\n\noptions orientation=landscape papersize=(24in 24in) ;\nods graphics on / reset width=24in height=24in  imagemap outputfmt=svg;\nods html close;ods rtf close;ods pdf close;ods document close; \nods html5 file=\"&outputpath./trajectories/USStateTrajectories.html\" gpath= \"&outputpath./trajectories\" device=svg options(svg_mode=\"inline\");\n\t\ttitle US States Trajectories;\n\tfootnote 'Data Source: Johns Hopkins University - https://github.com/CSSEGISandData/COVID-19';\n\t%global maxconfirmed maxdeaths;\n\t%setmax(allcompose_summary,location in (\"&usstates\") and deaths > 10);\n\tproc sgplot \n\t\tdata=allcompose_summary(where=(location in (\"&usstates\") and deaths > 10)) noautolegend;\n\t\tscatter x=Confirmed y=Deaths / group=location \n\t\t\tdatalabel=filedate\n\t\t\tmarkerattrs=(size=7) \n\t\t\tdatalabelattrs=(size=5) \n\t\t\ttransparency=0.25\n\t\t\ttip=(location filedate confirmed deaths);\n\t\tseries x=Confirmed y=Deaths  / group=location \n\t\t\ttip=(location filedate confirmed deaths);\n\t\txaxis grid type=log LOGSTYLE=LINEAR values=(200 1000 10000 10000 100000  );\n\t\tyaxis grid type=log LOGSTYLE=LINEAR values=(10 10 100 500  1000  10000   );\n\trun;\nods html5 close;\nods graphics / reset;\n\nPROC DELETE DATA=ALLCOMPOSE ALLCOMPOSE_SUMMARY PLOTSTATE;\nRUN;","snippet":"","resource":false},"properties":{"left":"36","top":"246","width":"100","height":"60","region":"output","fillcolor":"#E0E6F1","linecolor":"#6882a3","tooltip":"GraphTrajectories","portsonly":true,"key":"control","visible":true}},{"version":2,"type":"code","id":"8154285e-9821-4d31-8779-d0dc16bddb4d","name":"","label":"GraphPerCapita","description":"","created":1586041393432,"modified":1586041393432,"notes":"","parameters":{"server":"","target":"com.sas.ep.sascoder.execution.producers.VPP","action":"runSASCode","priority":"Reserved","code":"*****************************************************************\n***** GraphLocation.sas\n***** pulls and prepares csv data from covid19 and analyzes  \n***** data\n*****************************************************************;\n\n\n\n/*****************************************************************************************/\n/* Sanity Checkpoint */\n/* look for possible errors. I think it is sometimes reasonable to have multiple updates, \n\t\tbut probably not a lot... lets check*/\n/* \tdata errors_to_check; */\n/* \t\tset countylevel; */\n/* \t\tif freq > 1 then do; */\n/* \t\t\tput fips= location= census_state= census_county=; */\n/* \t\t\toutput; */\n/* \t\tend; */\n/* \trun; */\n/* \tproc sql; */\n/* \t\tselect *  */\n/* \t\t\tfrom jhu_current  */\n/* \t\t\twhere fips in ( */\n/* \t\t\t\tselect distinct fips  */\n/* \t\t\t\t\tfrom errors_to_check */\n/* \t\t\t\t)  */\n/* \t\t\torder by fips,filedate; */\n/* \tquit; */\n/*****************************************************************************************/\nproc sort data = JHU_CORE_TS_CENSUS_SUMMARY out=temp; by fips filedate; run;\ndata County_Most_Recent;\n\tset temp;\n\tlabel plotlabel=\"Location\";\n\tplotlabel=cats(census_county,\", \",census_state);\n\tif confirmed>0 then log_confirmed=log(confirmed); else log_confirmed=.;\n\tif population_estimate>0 then log_population_estimate=log(population_estimate); else log_population_estimate=.;\n\tby fips  filedate;\n\tif last.fips  and last.filedate then output;\nrun;\n\n\nproc rank data=county_most_recent out=County_Ranks groups=10 ties=dense;                               \n\tvar confirmed \n\t\tdeaths \n\t\tpopulation_estimate \n\t\temp_fatality_rate \n\t\tconfirmed_percapita \n\t\tdeaths_percapita;                                                          \n\tranks confirmed_rank \n\t\tdeaths_rank \n\t\tpopulation_estimate_rank \n\t\temp_fatality_rate_rank \n\t\tconfirmed_percapita_rank \n\t\tdeaths_percapita_rank;                                                      \nrun;\n\nproc sql;\n\t%let var=confirmed_rank;\n\tselect &var\n\t\t\t, count(*) as freq \n\tfrom county_ranks \n\tgroup by &var ; \nquit;\n\nproc sort data=County_Ranks;\n\tby location filedate;\nrun;\n\n\nproc sort data=County_Ranks;\n\tby descending confirmed_percapita;\nrun;\n\n%let rc = %sysfunc(dlgcdir(\"&outputpath\")); %put RC=&rc;\n\n\nproc reg data=county_ranks(where=(confirmed_rank>0 ));\n\tmodel log_confirmed=log_population_estimate / alpha=.2 ;\n\toutput out=regvals \n\t\tpredicted=p_log_confirmed \n\t\tlcl=lcl_log_confirmed \n\t\tucl=ucl_log_confirmed  \n\t\tlclm=lclm_log_confirmed \n\t\tuclm=uclm_log_confirmed\n\t\t;\nrun;\ndata regvals; set regvals;\n\tp_confirmed=exp(p_log_confirmed);\n\tucl_confirmed=exp(ucl_log_confirmed);\n\tlcl_confirmed=exp(lcl_log_confirmed);\n\tuclm_confirmed=exp(uclm_log_confirmed);\n\tlclm_confirmed=exp(lclm_log_confirmed);\n\tlabel p_confirmed=\"Confirmed Prediction\"\n\t\t  ucl_confirmed=\"Confirmed Prediction UCL\"\n\t\t  lcl_confirmed=\"Confirmed Prediction LCL\"\n\t\t  uclm_confirmed=\"Confirmed UCL\"\n\t\t  lclm_confirmed=\"Confirmed LCL\";\n/* \tif confirmed <= ucl_confirmed and confirmed > lcl_confirmed then plotlabel=''; */\n\tif confirmed <= ucl_confirmed-(ucl_confirmed*0.5) and confirmed > lcl_confirmed+(lcl_confirmed*0.3) then delete;\n\t\nrun;\n\n/*correct the series plots */\nproc sort data=regvals; by population_estimate; run;\n\noptions orientation=landscape papersize=(24in 24in) ;\nods graphics / reset width=23.5in height=23.5in imagemap outputfmt=svg;\nods html close;ods rtf close;ods pdf close;ods document close; \nods html5 \n\tbody=\"&outputpath./percapita/CountyPerCapita.html\" \n\tgpath= \"&outputpath/percapita/\" \n\tdevice=svg \n\toptions(svg_mode=\"inline\");\n\n\ttitle \"US Counties\";\n\ttitle2 \"Per Capita Confirmed Infections\";\n\tfootnote 'Data Source: Johns Hopkins University - https://github.com/CSSEGISandData/COVID-19';\n\tproc sgplot data=regvals(where=(confirmed_rank>0));\n\t\tbubble x=population_estimate \n\t\t\t   y=confirmed \n\t\t\t   size=deaths_rank / \n\t\t\tdatalabel=plotlabel\n\t\t\tfillattrs=(transparency=0.75) \n\t\t\tdatalabelpos=center \n\t\t\tdatalabelattrs=(size=6 ) \n\t\t\tbradiusmin=5 \n\t\t\tbradiusmax=20\n\t\t\ttip=(plotlabel confirmed deaths population_estimate confirmed_percapita deaths_percapita filedate);\n\t\tseries y=p_confirmed x=population_estimate  \t/ lineattrs=(color='green') ;\n\t\tseries y=ucl_confirmed x=population_estimate \t/ lineattrs=(color='orange')  ;\n\t\tseries y=lcl_confirmed x=population_estimate  \t/ lineattrs=(color='orange')  ;\n\t\txaxis grid type=log;\n\t\tyaxis grid type=log;\n\trun;\n\nods html5 close;\nods graphics / reset;\n\t\n\t\n\t\n\t\nproc delete data=temp County_Most_Recent county_ranks regvals; run;\n\n","snippet":"","resource":false,"dependencies":["1103de1b-51ed-416d-806c-9f034469f2c9"]},"properties":{"left":"230","top":"245","width":"100","height":"60","region":"output","fillcolor":"#E0E6F1","linecolor":"#6882a3","tooltip":"GraphPerCapita","portsonly":true,"key":"control","visible":true}},{"version":2,"type":"code","id":"49682746-089c-4bc9-8360-5e1364814321","name":"","label":"GraphICUHospital","description":"","created":1586041393433,"modified":1586085867363,"notes":"","parameters":{"server":"","target":"com.sas.ep.sascoder.execution.producers.VPP","action":"runSASCode","priority":"Reserved","code":"*********************************************************************\n***** GraphICUHospital.sas - Look at counties - very imperfect\t*****\n*****\t\t\t\t\t\tsmall regions.\t\t\t\t\t\t*****\n*****\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*****\n***** \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*****\n*********************************************************************;\n\n\n\nproc sql;\n\tcreate table MSA_ICU_summary as\t\n\t\tselect \n\t\t\tCSA_Title_Augmented\n\t\t\t,sum(confirmed) as confirmed\n\t\t\t,log(sum(confirmed)) as log_confirmed\n\t\t\t,sum(deaths) as deaths\n\t\t\t,log(sum(deaths)) as log_deaths\n\t\t\t,sum(recovered) as recovered\n\t\t\t,sum(total_county_hospitals) as MSA_hospitals\n\t\t\t,sum(total_county_icu_beds) as MSA_ICU_BEDS\n\t\t\t,log(sum(total_county_icu_beds)) as log_msa_icu_beds\n\t\t\t,sum(confirmed)/sum(total_county_hospitals) as confirmed_per_hospital\n\t\t\t,sum(confirmed)/sum(total_county_icu_beds) as confirmed_per_ICU_BED\n\t\tfrom work.JHU_CORE_LOC_MSA_ICU msa\n\t\twhere confirmed > 0\n\t\tgroup by csa_title_augmented\n\t\torder by csa_title_augmented\n\t\t;\nquit;\n\n\nproc rank data=msa_ICU_summary out=MSA_Ranks groups=5 ties=dense;                               \n\tvar confirmed \n\t\tdeaths \n\t\tmsa_hospitals \n\t\tmsa_icu_beds\n\t\tconfirmed_per_hospital\n\t\tconfirmed_per_icu_bed;                                                          \n\tranks confirmed_rank\n\t\tdeaths_rank \n\t\tmsa_hospitals_rank \n\t\tmsa_icu_beds_rank\n\t\tconfirmed_per_hospital_rank\n\t\tconfirmed_per_icu_bed_rank;                                                      \nrun;\n\nproc reg data=MSA_RANKS(where=(confirmed_rank>0 and confirmed>0 and msa_icu_beds>0));\n\tmodel log_confirmed=log_msa_icu_beds / alpha=.2 ;\n\toutput out=MSA_regvals \n\t\tpredicted=p_log_confirmed \n\t\tlcl=lcl_log_confirmed \n\t\tucl=ucl_log_confirmed  \n\t\tlclm=lclm_log_confirmed \n\t\tuclm=uclm_log_confirmed\n\t\t;\nrun;\n\ndata MSA_regvals; set MSA_regvals;\n\tp_confirmed=exp(p_log_confirmed);\n\tucl_confirmed=exp(ucl_log_confirmed);\n\tlcl_confirmed=exp(lcl_log_confirmed);\n\tuclm_confirmed=exp(uclm_log_confirmed);\n\tlclm_confirmed=exp(lclm_log_confirmed);\n\tlabel p_confirmed=\"Confirmed Prediction\"\n\t\t  ucl_confirmed=\"Confirmed Prediction UCL\"\n\t\t  lcl_confirmed=\"Confirmed Prediction LCL\"\n\t\t  uclm_confirmed=\"Confirmed UCL\"\n\t\t  lclm_confirmed=\"Confirmed LCL\";\n\tif confirmed <= ucl_confirmed - (ucl_confirmed*0.25)\n\t\tand confirmed > lcl_confirmed \n\t\tthen delete;\n\tlabel CSA_TITLE_AUGUMENTED=\"CBSA\";\nrun;\n\n/*\nproc sql;\nselect confirmed_per_icu_bed_rank,count(*) as freq from msa_regvals group by confirmed_per_icu_bed_rank order by confirmed_per_icu_bed_rank;\nquit;\n*/\n\ndata msa_regvals;\n\tset msa_regvals;\n\tif msa_icu_beds>0 then confirmed_ICU_ratio=confirmed/msa_icu_beds;\n\tlabel Confirmed_icu_ratio = \"Ratio of Confirmed:ICU Beds\";\nrun;\nproc sort data=msa_regvals; by msa_icu_beds; run;\n\noptions orientation=landscape papersize=(24in 24in) ;\nods graphics / reset width=23.5in height=23.5in imagemap outputfmt=svg;\nods html close;ods rtf close;ods pdf close;ods document close; \nods html5 \n\tbody=\"&outputpath./percapita/MSA_ICU_BEDS.html\" \n\tgpath= \"&outputpath/percapita/\" \n\tdevice=svg \n\toptions(svg_mode=\"inline\");\n\t\n\tproc sgplot data=MSA_regvals(where=(confirmed_rank>0 and confirmed>0 and msa_icu_beds>0));\n\t\tlabel confirmed=\"Confirmed\"\n\t\t\t  deaths_rank =\"Deaths Rank\"\n\t\t\t  msa_icu_beds=\"Number of ICU Beds in CBSA/Area\"\n\t\t;\n\t\tbubble x=MSA_ICU_BEDS\n\t\t\t   y=confirmed\n\t\t\t   size=deaths_rank/\n\t\t\tdatalabel=csa_title_augmented \n\t\t\tdatalabelpos=center \n\t\t\tdatalabelattrs=(size=6 ) \n\t\t\tfillattrs=(transparency=0.75) \n\t\t\tdatalabelpos=center \n\t\t\tdatalabelattrs=(size=6 ) \n\t\t\tbradiusmin=5 \n\t\t\tbradiusmax=20\n\t\t\ttip =(csa_title_augmented confirmed deaths msa_icu_beds confirmed_icu_ratio)\n\t\t\ttiplabel=('CSBA:' 'Confirmed:' \"Deaths:\" \"ICU Beds\" \"Case per ICU Bed:\")\n\t\t\ttipformat =($25. best12. best12. best12. best12.3);\n\t\tseries y=p_confirmed x=msa_icu_beds  \t/ lineattrs=(color='green') ;\n\t\tseries y=lcl_confirmed x=msa_icu_beds  \t/ lineattrs=(color='orange') ;\n\t\tseries y=ucl_confirmed x=msa_icu_beds  \t/ lineattrs=(color='orange') ;\n\t\txaxis grid type=log values=(2 5 10 50 100 250 500  1000   10000);\n\t\tyaxis grid type=log values=(5 10 100 1000 100000 100000);\n\trun;\nods html5 close;\nods graphics / reset;\n\n\n/*\nproc print data=msa_regvals;\n\tvar csa_title_augmented msa_icu_beds confirmed p_confirmed lcl_confirmed ucl_confirmed;\nrun;\n*/\nproc delete data=\n\tMSA_ICU_summary\n\tmsa_ranks\n\tmsa_regvals\n\t;\nrun;\n\n\t\n\t\n","snippet":"","resource":false,"dependencies":["8154285e-9821-4d31-8779-d0dc16bddb4d"]},"properties":{"left":"428","top":"245","width":"100","height":"60","region":"output","fillcolor":"#E0E6F1","linecolor":"#6882a3","tooltip":"GraphICUHospital","portsonly":true,"key":"control","visible":true}},{"version":2,"type":"code","id":"aeaf9cb2-2ecb-4786-8f22-10872505db0b","name":"","label":"GenerateIndividualPlots","description":"","created":1586085873246,"modified":1586085915301,"notes":"","parameters":{"server":"","target":"com.sas.ep.sascoder.execution.producers.VPP","action":"runSASCode","priority":"Reserved","code":"\n%include \"&progpath./MACROS.sas\";\n%PlotInd(,Georgia,-US);*,ta=1,dt=20200403,ac=5831,ad=184);*,jt=0,jd=0,jc=0,jd=0);\n%PlotInd(,Massachusetts,-US);\n%PlotInd(,California,-US);\n%PlotInd(,Illinois,-US);\n%PlotInd(,Florida,-US);\n%PlotInd(,Texas,-US);\n%PlotInd(,New York,-US);\n%PlotInd(,New Jersey,-US);\n%PlotInd(,South Carolina,-US);\n%PlotInd(,North Carolina,-US);\n%PlotInd(,New Hampshire,-US);\n%PlotInd(,Louisiana,-US);\n%PlotInd(,Michigan,-US);\n%PlotInd(,Pennsylvania,-US);\n\n\n%PlotInd(Nation:,Germany,);\n%PlotInd(Nation:,Russia,);\n%PlotInd(Nation:,India,);\n\n","snippet":"","resource":false,"dependencies":["49682746-089c-4bc9-8360-5e1364814321"]},"properties":{"left":"661","top":"247","width":"100","height":"60","region":"output","fillcolor":"#E0E6F1","linecolor":"#6882a3","tooltip":"GenerateIndividualPlots","portsonly":true,"key":"control","visible":true}}],"ports":[{"version":2,"type":"port","id":"9c4ae1fa-8576-4223-85a3-1129905081cf","name":"","label":"","description":"","created":1586041393433,"modified":1586041393433,"notes":"","parameters":{},"properties":{"left":"16","top":"269","width":"13","height":"13","parent":"1103de1b-51ed-416d-806c-9f034469f2c9","region":"input","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"623c3b1e-90e4-466d-81b7-22d47bf51f41","name":"","label":"","description":"","created":1586041393433,"modified":1586041393433,"notes":"","parameters":{},"properties":{"left":"143","top":"269","width":"13","height":"13","parent":"1103de1b-51ed-416d-806c-9f034469f2c9","region":"output","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"e548d478-f31e-4847-8a9f-87e7d55956fe","name":"","label":"","description":"","created":1586041393433,"modified":1586041393433,"notes":"","parameters":{},"properties":{"left":"210","top":"268","width":"13","height":"13","parent":"8154285e-9821-4d31-8779-d0dc16bddb4d","region":"input","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"298dd492-ca76-4ca3-80b3-2a0e1e749b52","name":"","label":"","description":"","created":1586041393433,"modified":1586041393433,"notes":"","parameters":{},"properties":{"left":"337","top":"268","width":"13","height":"13","parent":"8154285e-9821-4d31-8779-d0dc16bddb4d","region":"output","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"27739a7c-7e21-499f-87da-6fbacd5b7516","name":"","label":"","description":"","created":1586041393434,"modified":1586041393434,"notes":"","parameters":{},"properties":{"left":"408","top":"268","width":"13","height":"13","parent":"49682746-089c-4bc9-8360-5e1364814321","region":"input","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"63e48f3a-758b-45c2-8edd-fd5130d846c5","name":"","label":"","description":"","created":1586041393434,"modified":1586041393434,"notes":"","parameters":{},"properties":{"left":"535","top":"268","width":"13","height":"13","parent":"49682746-089c-4bc9-8360-5e1364814321","region":"output","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"18f81f4f-2c1a-4f9b-88ee-83b2dfdf5c94","name":"","label":"","description":"","created":1586085873252,"modified":1586085915300,"notes":"","parameters":{},"properties":{"left":"641","top":"270","width":"13","height":"13","parent":"aeaf9cb2-2ecb-4786-8f22-10872505db0b","region":"input","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"bfc767c2-47eb-4016-8588-808ad92c2981","name":"","label":"","description":"","created":1586085873253,"modified":1586085915300,"notes":"","parameters":{},"properties":{"left":"768","top":"270","width":"13","height":"13","parent":"aeaf9cb2-2ecb-4786-8f22-10872505db0b","region":"output","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}}],"connectors":[{"version":2,"type":"link","id":"6c9cb7fe-54d5-454d-883c-48f1247688a8","name":"","label":"","description":"","created":1586041393434,"modified":1586041393434,"notes":"","parameters":{},"properties":{"linecolor":"#C0C0C0","linestyle":"Dash"},"sources":[{"value":"623c3b1e-90e4-466d-81b7-22d47bf51f41"}],"targets":[{"value":"e548d478-f31e-4847-8a9f-87e7d55956fe"}]},{"version":2,"type":"link","id":"8f53cc0d-11b2-4421-8a64-3eb15f57bd2b","name":"","label":"","description":"","created":1586041393434,"modified":1586041393434,"notes":"","parameters":{},"properties":{"linecolor":"#C0C0C0","linestyle":"Dash"},"sources":[{"value":"298dd492-ca76-4ca3-80b3-2a0e1e749b52"}],"targets":[{"value":"27739a7c-7e21-499f-87da-6fbacd5b7516"}]},{"version":2,"type":"link","id":"91534802-0283-45d3-83db-1e8b5a2a2a4a","name":"","label":"","description":"","created":1586085875704,"modified":1586085875704,"notes":"","parameters":{},"properties":{"linecolor":"#C0C0C0","linestyle":"Dash"},"sources":[{"value":"63e48f3a-758b-45c2-8edd-fd5130d846c5"}],"targets":[{"value":"18f81f4f-2c1a-4f9b-88ee-83b2dfdf5c94"}]}]}],"ports":[{"version":2,"type":"port","id":"46f083ff-fca3-4744-81b6-f05d750576fe","name":"","label":"","description":"","created":1586028541978,"modified":1586043424772,"notes":"","parameters":{},"properties":{"left":"30","top":"54","width":"13","height":"13","parent":"12a66eed-12fe-4369-8ea5-69efc5ec47f5","region":"input","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"55f7293d-800b-44b9-8680-510101e13200","name":"","label":"","description":"","created":1586028541979,"modified":1586043424772,"notes":"","parameters":{},"properties":{"left":"157","top":"54","width":"13","height":"13","parent":"12a66eed-12fe-4369-8ea5-69efc5ec47f5","region":"output","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"529b2ef3-9ef6-470a-81ea-83b9875b1762","name":"","label":"","description":"","created":1586028541980,"modified":1586043361091,"notes":"","parameters":{},"properties":{"left":"220","top":"53","width":"13","height":"13","parent":"c5754165-c156-4f6a-80c0-542ce5cb0c1e","region":"input","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"738edb90-8a84-4275-8e3e-7b1efbd56154","name":"","label":"","description":"","created":1586028541980,"modified":1586043361091,"notes":"","parameters":{},"properties":{"left":"347","top":"53","width":"13","height":"13","parent":"c5754165-c156-4f6a-80c0-542ce5cb0c1e","region":"output","readonly":false,"disabled":false,"fillcolor":"#E0E6F1","linecolor":"#6882a3","key":"control"}},{"version":2,"type":"port","id":"3b38499e-23d0-406a-8983-d36d9dcc78b0","name":"","label":"","description":"","created":1586041384808,"modified":1586043361092,"notes":"","parameters":{},"properties":{"left":"410","top":"53","width":"13","height":"13","parent":"40a807ad-5b30-45f8-80f7-f2e5c68560be","region":"input","readonly":false,"disabled":false,"fillcolor":"#FCFCFC","linecolor":"#9a9a9a","key":"control"}},{"version":2,"type":"port","id":"33df384c-feaf-4545-8320-b8d8efe71954","name":"","label":"","description":"","created":1586041384809,"modified":1586043361092,"notes":"","parameters":{},"properties":{"left":"537","top":"53","width":"13","height":"13","parent":"40a807ad-5b30-45f8-80f7-f2e5c68560be","region":"output","readonly":false,"disabled":false,"fillcolor":"#FCFCFC","linecolor":"#9a9a9a","key":"control"}},{"version":2,"type":"port","id":"de46573a-5ebd-4e6a-8e5e-650296b49522","name":"","label":"","description":"","created":1586041393430,"modified":1586043361093,"notes":"","parameters":{},"properties":{"left":"600","top":"53","width":"13","height":"13","parent":"e3a49f07-37dc-445d-8600-3007ae53d83a","region":"input","readonly":false,"disabled":false,"fillcolor":"#FCFCFC","linecolor":"#9a9a9a","key":"control"}},{"version":2,"type":"port","id":"87d92d80-811f-4c3e-888a-813b25020c4b","name":"","label":"","description":"","created":1586041393431,"modified":1586043361093,"notes":"","parameters":{},"properties":{"left":"727","top":"53","width":"13","height":"13","parent":"e3a49f07-37dc-445d-8600-3007ae53d83a","region":"output","readonly":false,"disabled":false,"fillcolor":"#FCFCFC","linecolor":"#9a9a9a","key":"control"}}],"connectors":[{"version":2,"type":"link","id":"fc6fe71d-ae67-431f-8d01-c6b81b6a1c91","name":"","label":"","description":"","created":1586028541981,"modified":1586028541981,"notes":"","parameters":{},"properties":{"linecolor":"#C0C0C0","linestyle":"Dash"},"sources":[{"value":"55f7293d-800b-44b9-8680-510101e13200"}],"targets":[{"value":"529b2ef3-9ef6-470a-81ea-83b9875b1762"}]},{"version":2,"type":"link","id":"b9ab2b5a-43cb-46b9-8e66-608c2f68b58f","name":"","label":"","description":"","created":1586041384814,"modified":1586041384814,"notes":"","parameters":{},"properties":{"linecolor":"#C0C0C0","linestyle":"Dash"},"sources":[{"value":"738edb90-8a84-4275-8e3e-7b1efbd56154"}],"targets":[{"value":"3b38499e-23d0-406a-8983-d36d9dcc78b0"}]},{"version":2,"type":"link","id":"09e0e4f4-bd8b-42a5-8baf-96a4320f0e14","name":"","label":"","description":"","created":1586041393435,"modified":1586041393435,"notes":"","parameters":{},"properties":{"linecolor":"#C0C0C0","linestyle":"Dash"},"sources":[{"value":"33df384c-feaf-4545-8320-b8d8efe71954"}],"targets":[{"value":"de46573a-5ebd-4e6a-8e5e-650296b49522"}]}]}